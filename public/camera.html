<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bluma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    
    <title>Camera - CamSalvo</title>
  </head>
  <body>
    <div id="app">
        <section class="hero is-dark is-fullheight" v-show="page == 'setup'">
            <div class="hero-body">
              <div class="">
                <p class="title">
                  Device name
                </p>
                <input class="input is-primary" type="text" placeholder="Name to show in dashboard" style="margin-bottom: 1.5rem;" v-model="device.name">
                <button class="button is-primary" :disabled="device.name.length == 0" v-on:click="page_camera">Next</button>
              </div>
            </div>
        </section>
        <div v-show="page == 'camera'" ref="page-camera">
            <video autoplay style="width:100vw;height:100vh;" ref="video-canvas"></video>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.20/vue.global.min.js"></script>
    <script>
 
    </script>
    <script>
        const CameraApp = {
            data(){
                return {
                    dashboards: {},
                    socket: undefined,
                    config: undefined,
                    page: "setup",
                    device: {
                        name: "",
                    }
                }
            },
            mounted(){
            },
            methods: {
                async connect(){
                    response = await fetch('config.json'); 
                    if(!response.ok) return this.dialogue("Error: could not load config.json");
                    this.config = await response.json();
                    this.init_socket();
                },
                init_socket(){
                    self = this;
                    socket_url = 'ws://'+this.config.socket_server.address+':'+this.config.socket_server.port+'/camera';
                    console.log(socket_url);
                    this.socket = io(socket_url)
                    this.socket.on('connect', ()=>{
                        console.log("CONNECTED")
                    });
                    this.socket.on('connect_error', error=>self.dialogue('could not conenct to socket server. please verify that node.js is up and running with proper config.js'))
                    this.socket.on('reconnect_failed', error=>self.dialogue('internete disconnect! you might move your phone to far away from internet access point'))
                    this.socket.on('add_dashboard', this.add_dashboard)
                    this.socket.on('remove_dashboard', this.remove_dashboard)                    
                },
                dialogue(message){
                    alert(message);
                },
                add_dashboard(data){
                    data['dashboard_ids']
                }, 
                remove_dashboard(data){
                    self = this;
                    data['dashboard_ids'].forEach(id=>{
                        delete self.dashboards[id]
                    })
                },
                async page_camera(){
                    this.page = 'camera';
                    await this.$refs['page-camera'].requestFullscreen({navigationUI: 'hide'}).catch(() => dialogue('Cannot request fullscreen'))  
                    console.log(this.config.preview);                  
                    mediaStream = await navigator.mediaDevices.getUserMedia({"video": this.config.preview})
                    this.$refs['video-canvas'].srcObject = mediaStream
                    track = mediaStream.getVideoTracks()[0];
                    this.device['track'] = track
                    this.device['settings'] = track.getSettings();
                    this.device['capabilities'] = track.getCapabilities();
                    this.connect();
                },
                async call_dashboard(dashboard_id){
                    // make RTC call to dashboard
                    peerConnection = new RTCPeerConnection(this.camera);
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(new RTCSessionDescription(offer));
                    io.of('dashboard').to(dashboard_id).emit('rtc_call', {"offer": offer});
                },
                async answer_dashboard(data){
                    dashboard_id = data['dashboard_id']
                    aw
                }
            }
        }
        Vue.createApp(CameraApp).mount('#app')        
    </script>

  </body>
</html>